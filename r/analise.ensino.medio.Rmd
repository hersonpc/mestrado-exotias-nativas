---
title: "Mestrado Biologia"
author: "Herson Melo"
date: "28/06/2018"
output: 
  html_notebook
---

```{r, echo=FALSE, warning=FALSE, error=FALSE, include = FALSE}
library(lubridate)
library(dplyr)
library(stringr)
library(reshape2)
library(ggplot2)
library(ggpubr)
library(grid)
library(gridExtra)
library(knitr)
library(kableExtra)
library(nortest)
library(stats)
library(multcompView)

suppressWarnings(Sys.setlocale("LC_ALL", 'en_US.UTF-8'))
options(scipen = 999, digits = 4)
#options("scipen"=-100, "digits"=10)
# getwd()
load("dados.RData")
```

## Análise do Jogo de Imagens aplicadas no Ensino médio

Roteiro de análise:

1. Amostra dos dados da pesquisa realizada
2. Determinar normalidade
3. Determinar 
4. Histograma

### Amostra dos dados da pesquisa realizada

Tabulação do número de acertos dos itens do jogo de imagens.

```{r, echo=FALSE}
desc_colunas <- data.frame(
    "Coluna" = c("Exoticas", "Nativas"),
    "Descrição" = c("Número de acertos dentre todas as imagens exibidas do tipo exótica, valor experado é 5.",
                    "Número de acertos dentre todas as imagens exibidas do tipo nativa, valor experado é 5.")
    )
desc_colunas %>%
  kable() %>%
  kable_styling(c("striped", "bordered"), full_width = TRUE) %>%
  column_spec(1, bold = TRUE)

```


```{r}
head(pos_gabarito$dados, 10)
```

#### Determinado a taxa de percepção

Entende-se por taxa de percepção o fator determinado pela quantidade média de acertos dentre as questões apresentadas aos alunos, em relação a turma em que o questionario foi aplicado.

```{r}
print(pos_gabarito$proporcoes$por_turma)
```

### Teste de normalidade

Para determinar a normalidade nas distribuiçoes das respostas do jogo de imagens.

```{r, echo=FALSE}
normalidade <- function(x) {
    t1 <- shapiro.test(x)
    t2 <- sf.test(x)
    t3 <- lillie.test(x)
    t4 <- ad.test(x)
    t5 <- cvm.test(x)
    return( data.frame(
        Algoritmo = c(t1$method, t2$method, 
                   t3$method, t4$method, 
                   t5$method),
        p.valor = c(t1$p.value, t2$p.value, 
                    t3$p.value, t4$p.value, 
                    t5$p.value),
        Normalidade = c(t1$p.value > .05, t2$p.value > .05, 
                      t3$p.value > .05, t4$p.value > .05, 
                      t5$p.value > .05)
    ))
}

grafico_densidade <- function(variavel, cor, titulo) {
    plot <- 
        pos_gabarito$proporcoes$por_turma %>% 
        ggdensity(x = variavel, fill = cor,
          main = titulo,
          xlab = "Percentual de acertos") + 
        xlim(0, 1) + 
        ylim(0, 8)
    nomalidade <- 
        ggtexttable(
            normalidade(pos_gabarito$proporcoes$por_turma[[variavel]]), 
            rows = NULL, theme = ttheme(base_style = "mOrange", base_size = 8)
        )
    
    resultado <- list(
        plot = plot,
        normalidade = nomalidade
    )
    return(resultado)
}

t1 <- grafico_densidade("p_nativas", "green", "Identificação do nome das espécies de origem Nativas")
t2 <- grafico_densidade("p_exoticas", "red", "Identificação do nome das espécies de origem Exóticas")
t3 <- grafico_densidade("p_origem_nativas", "darkgreen", "Identificação de origem Nativas")
t4 <- grafico_densidade("p_origem_exoticas", "darkred", "Identificação de origem Exóticas")
t5 <- grafico_densidade("p_indice_nativas", "orange", "Indice de reconhecimento Nativas (origens + espécies)")
t6 <- grafico_densidade("p_indice_exoticas", "orangered", "Indice de reconhecimento Exóticas (origens + espécies)")
```

#### Identificação médio das turmas (nomes das espécies & origens)

```{r fig.width=8, fig.height=5}
grid.arrange(t1$plot, t2$plot,
             t1$normalidade, t2$normalidade,
             t3$plot, t4$plot,
             t3$normalidade, t4$normalidade,
             ncol = 2,
             heights = c(3,2,3,2),
             top = textGrob("Densidade de identificação média das turmas entre \nespecies e suas origens\n",
                            gp = gpar(fontsize = 20, font = 2))
             )
```

#### Indice de reconhecimento médio das turmas

```{r fig.width=8, fig.height=3}
grid.arrange(t5$plot, t6$plot,
             t5$normalidade, t6$normalidade,
             ncol = 2,
             heights = c(4,3),
             top = textGrob("Densidade dos indices de reconhecimento médio das turmas\n",
                            gp = gpar(fontsize = 20, font = 2))
             )
```


### Q-Q Test

```{r, fig.width=6, fig.height=4}
qqplot.data <- function (vec, titulo) {
  # following four lines from base R's qqline()
  y <- quantile(vec[!is.na(vec)], c(0.25, 0.75))
  x <- qnorm(c(0.25, 0.75))
  slope <- diff(y)/diff(x)
  int <- y[1L] - slope * x[1L]

  d <- data.frame(resids = vec)

  ggplot(d, aes(sample = resids)) + 
      stat_qq() + 
      geom_abline(slope = slope, intercept = int, col = "red") +
      xlim(-2, 2) +
      ylim(0, 1) +
      theme_bw() +
      labs(
        title = titulo
    )
}

q1 <- qqplot.data(pos_gabarito$proporcoes$por_turma$p_nativas, "Identificação do nome das espécies de origem Nativas")
q2 <- qqplot.data(pos_gabarito$proporcoes$por_turma$p_exoticas, "Identificação do nome das espécies de origem Exoticas")
q3 <- qqplot.data(pos_gabarito$proporcoes$por_turma$p_origem_nativas, "Identificação de origem Nativas")
q4 <- qqplot.data(pos_gabarito$proporcoes$por_turma$p_origem_exoticas, "Identificação de origem Exoticas")
q5 <- qqplot.data(pos_gabarito$proporcoes$por_turma$p_indice_nativas, "Indice de reconhecimento Nativas (origens + espécies)")
q6 <- qqplot.data(pos_gabarito$proporcoes$por_turma$p_indice_exoticas, "Indice de reconhecimento Exoticas (origens + espécies)")

grid.arrange(q1, q2, 
             q3, q4,
             q5, q6,
             ncol = 2,
             top = textGrob("Normal Q-Q Plot\n", 
                            gp = gpar(fontsize = 20, font = 2))
             )
```

### Teste de variância

Para determinar a variância

```{r}
variancia <- data.frame(
    Algoritmo = c("F test to compare two variances"),
    "Comparação" = c("Nativas x Exóticas"),
    "Variável" = c(
        "Indice de reconhecimento",
        "Identificação do nome das espécies",
        "Identificação da origem"
    ),
    "p_valor" = c(
        var.test(pos_gabarito$proporcoes$por_turma$p_indice_nativas, 
                 pos_gabarito$proporcoes$por_turma$p_indice_exoticas, 
                 alternative = "two.sided")$p.value,
        var.test(pos_gabarito$proporcoes$por_turma$p_nativas, 
                 pos_gabarito$proporcoes$por_turma$p_exoticas, 
                 alternative = "two.sided")$p.value,
        var.test(pos_gabarito$proporcoes$por_turma$p_origem_nativas, 
                 pos_gabarito$proporcoes$por_turma$p_origem_exoticas, 
                 alternative = "two.sided")$p.value
    )
)

variancia <- variancia %>%
    mutate(
        variancia = p_valor > 0.05,
        p_valor = cell_spec(round(p_valor, 4), bold = T, color = "black", align = "right"),
        variancia = cell_spec(variancia, bold = variancia,
                       color= ifelse(variancia, "white", "black"), 
                       background = ifelse(variancia, "green", "#CCCCCC"))
    )

variancia %>%
  kable(escape = F) %>%
  kable_styling(c("striped", "bordered"), full_width = TRUE) %>%
  column_spec(1, bold = TRUE) %>%
  collapse_rows(columns = 1:2, valign = "top") 
```

### Analises descritivas

```{r}
head(pos_gabarito$especies, 10)
```

#### Indice de identificação por Origem

```{r, fig.width=8, fig.height=4}
pos_gabarito$especie %>% 
    ggplot(aes(especieDesc, fr, fill = grupo)) + 
    geom_bar(stat="identity") +
    geom_text(aes(label = paste0(round(fr * 100, 1), "%")), 
              position = position_dodge(0.9), vjust = 0.5,
              hjust = -0.5) +
    scale_y_continuous(limits = c(0,1.2), labels = scales::percent) +
    facet_wrap(~origem, scales = "free_y") +
    coord_flip() +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1),
          legend.position = "top") +
    labs(title = "Indice de Identificação por Origem",
         fill = "Grupos", x = "", y = "\nFrequencia relativa")

```

#### Indice de identificação por Espécie

```{r, fig.width=8, fig.height=4}
pos_gabarito$especie %>% 
    ggplot(aes(especieDesc, fr, fill = origem)) + 
    geom_bar(stat="identity") +
    geom_text(aes(label = paste0(round(fr * 100, 1), "%")), 
              position = position_dodge(0.9), vjust = 0.5,
              hjust = -0.3) +
    scale_y_continuous(limits = c(0,1.2), labels = scales::percent) +
    facet_wrap(~grupo, scales = "free_y") +
    coord_flip() +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1),
          legend.position = "top") +
    labs(title = "Indice de Identificação por Espécie",
         fill = "Origem", x = "", y = "\nFrequencia relativa")
```


### Testes de hipoteses

Esperado p-valor >= 0.05 na normalidade (espera-se H0)
Esperado p-valor <= 0.05 no teste de hipotese (espera-se H1)

1. Os alunos itendificam mais os nomes dos animais de espécies exóticas que os animais de espécies nativas.

**TEST T-student**  
H0 = Tident(exoticas) = Tident(nativas)  
H1 = Tident(exoticas) > Tident(nativas)

```{r, fig.width=8, fig.height=3}
## Hipotese 1
tmp <- pos_gabarito$proporcoes$por_turma %>%
  select(turmas, p_nome_exoticas = p_exoticas, p_nome_nativas = p_nativas, p_origem_exoticas:p_indice_nativas) %>%
  melt(id = "turmas")

cbind(tmp, colsplit(tmp$variable, "_", c("p", "indicador", "origem"))) %>%
  select(turmas, indicador, origem, value) %>%
  ggplot() + 
  geom_boxplot(aes(x = origem, y = value, fill = origem), show.legend = F) + 
  scale_y_continuous(limits = c(0,1), labels = scales::percent) +
  facet_wrap(~indicador) +
  theme_bw() +
  labs(title = "Boxplot de identificação dos critérios estabelecidos",
       y = "Percentual de identificação", x = "")
```

```{r}
t1 <- t.test(pos_gabarito$proporcoes$por_turma$p_indice_nativas, 
       pos_gabarito$proporcoes$por_turma$p_indice_exoticas, 
       alternative = "two.sided", paired = F, var.equal = T)
t2 <- t.test(pos_gabarito$proporcoes$por_turma$p_nativas, 
       pos_gabarito$proporcoes$por_turma$p_exoticas, 
       alternative = "two.sided", paired = F, var.equal = T)
t3 <- t.test(pos_gabarito$proporcoes$por_turma$p_origem_nativas, 
       pos_gabarito$proporcoes$por_turma$p_origem_exoticas, 
       alternative = "two.sided", paired = F, var.equal = T)

data.frame(
    Algoritmo = c(t1$method, t2$method, t3$method),
    "Comparação" = c("Nativas x Exóticas"),
    "Variável" = c(
        "Indice de reconhecimento",
        "Identificação do nome das espécies",
        "Identificação da origem"
    ),
    p_valor = c(t1$p.value, t2$p.value, t3$p.value),
    H0 = c(t1$p.value >= 0.05, t2$p.value >= 0.05, t3$p.value >= 0.05),
    H1 = c(t1$p.value < 0.05, t2$p.value < 0.05, t3$p.value < 0.05),
    "Confiança" = c(
        paste(paste0(round(t1$conf.int * 100, 2), "%"), collapse = " ~ "),
        paste(paste0(round(t2$conf.int * 100, 2), "%"), collapse = " ~ "),
        paste(paste0(round(t3$conf.int * 100, 2), "%"), collapse = " ~ ")
    )
) %>%
  mutate(
    p_valor = cell_spec(round(p_valor, 4), bold = T, color = "black", align = "right"),
    H0 = cell_spec(H0, bold = H0,
                   color= ifelse(H0, "white", "black"), 
                   background = ifelse(H0, "green", "#CCCCCC")),
    H1 = cell_spec(H1, bold = H1, 
                   color = ifelse(H1, "white", "black"), 
                   background = ifelse(H1, "green", "#CCCCCC"))
  ) %>%
  kable(escape = F) %>%
  kable_styling(c("striped", "bordered"), full_width = TRUE) %>%
  column_spec(1, bold = TRUE) %>%
#  column_spec(4, bold = T, color = "darkblue") %>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  footnote(general = "Intervalo de confiança 95%",
           general_title = "\nObs.: ",
           footnote_as_chunk = T)
```


```{r}
## Hipotese 1
# t.test(jogo.dados.em.p$p_nativas, jogo.dados.em.p$p_exoticas, 
#        alternative = "two.sided", paired = F, var.equal = T)
```

2. Os alunos identificam mais espécies de origem exótica que as de origem nativa.

**TEST T-student**  
H0 = Tident(origem.exoticas) = Tident(origem.nativas)  
H1 = Tident(origem.exoticas) > Tident(origem.nativas)

```{r}
## Hipotese 2
t.test(pos_gabarito$proporcoes$por_turma$p_origem_nativas, 
       pos_gabarito$proporcoes$por_turma$p_origem_exoticas, 
       alternative = "two.sided", paired = F, var.equal = T)
```

3. Os alunos identificam mais as espécies exóticas (nome dos animais e origem) que espécies nativas.

**ANOVA**  

```{r}
# t.test(jogo.dados.em.p$p_nativas, jogo.dados.em.p$p_origem_nativas, 
#        alternative = "two.sided", paired = F, var.equal = T)
# t.anova <- aov(g2$proporcao ~ g2$especie + g2$tipo)
# summary(t.anova)
```

4. Os alunos reconhecem mais mamíferos do que os demais grupos taxonómicos.

**ANOVA**  


```{r, fig.width=8, fig.height=5}
## Hipotese 4
dadosANOVA <- 
    pos_gabarito$taxonomicos %>%
    select(turmas, grupos = grupo, valor)
#anova <- aov(data = pos_gabarito$taxonomicos, valor ~ grupo + origem)
anova <- aov(data = dadosANOVA, valor ~ grupos)
summary(anova)
tukey <- TukeyHSD(anova)
tukey
#plot(tukey, las = 1, col = "brown")

tky = as.data.frame(tukey$grupos)
tky$pair = rownames(tky)
ggplot(tky, aes(colour = cut(`p adj`, c(0, 0.01, 0.05, 1), 
                           label = c("p<0.01","p<0.05","Não significativo")))) +
    geom_hline(yintercept=0, lty="11", colour="grey30") +
    geom_errorbar(aes(pair, ymin=lwr, ymax=upr), width=0.2) +
    geom_point(aes(pair, diff)) +
    coord_flip() +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1),
          legend.position = "top") +
    labs(title = "Tukey",
         colour = "", x = "Comparação", y = "Diferença")
    
```

```{r, fig.width=8, fig.height=8}
## Hipotese 4
dadosANOVA <- 
    pos_gabarito$taxonomicos %>%
    mutate(grupos = paste(grupo, "@", origem)) %>%
    select(turmas, grupos, valor)
#anova <- aov(data = pos_gabarito$taxonomicos, valor ~ grupo + origem)
anova <- aov(data = dadosANOVA, valor ~ grupos)
summary(anova)
tukey <- TukeyHSD(anova)
tukey
#plot(tukey, las = 1, col = "brown")

tky = as.data.frame(tukey$grupos)
tky$pair = rownames(tky)
ggplot(tky, aes(colour = cut(`p adj`, c(0, 0.01, 0.05, 1), 
                           label = c("p<0.01","p<0.05","Non-Sig")))) +
    geom_hline(yintercept=0, lty="11", colour="grey30") +
    geom_errorbar(aes(pair, ymin=lwr, ymax=upr), width=0.2) +
    geom_point(aes(pair, diff)) +
    coord_flip() +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, hjust = 1),
          legend.position = "top") +
    labs(title = "Tukey",
         colour = "", x = "Comparação", y = "Diferença")
    
```

5. 

```{r}
## Hipotese 4
# t.test(jogo.dados.em.p$p_exoticas, jogo.dados.em.p$p_origem_exoticas, 
#        alternative = "two.sided", paired = F, var.equal = T)
```

6. Estudantes que residem na Cidade 1 (com UC) identificam mais espécies nativas do que estudantes que residem na Cidade 2 (sem UC).

```{r}
proporcoesPorMunicipio <-
    merge(
        pos_gabarito$dados %>% select(turmas, municipio) %>% unique(),
        pos_gabarito$proporcoes$por_turma
    ) 

nat_silvania <-
    (proporcoesPorMunicipio %>%
        filter(municipio == "Silvânia"))$p_nativas
nat_belavista <-
    (proporcoesPorMunicipio %>%
        filter(municipio == "Bela Vista de Goiás"))$p_nativas
    
#cbind(nat_silvania, nat_belavista)
#boxplot(nat_silvania, nat_belavista)
#summary(nat_silvania)
#summary(nat_belavista)
#var.test(nat_silvania, nat_belavista, alternative = "two.sided")

t.test(nat_silvania, nat_belavista,
       alternative = "two.sided", paired = F, var.equal = T)
```

<!-- 7. Estudantes que residem em área rural tem maior conhecimento sobre as espécies nativas. -->

<!-- **ANOVA** -->

<!-- #### Dados -->

<!-- Dados são agrupados por Municipio, turmas e área de residência: -->

<!-- ```{r} -->
<!-- jogo.dados.em.p1 <- jogo.dados.em.limpo %>%  -->
<!--     group_by(municipio, turmas, area) %>% -->
<!--     summarise(qtde = n(), -->
<!--               total_acertos_esperado = qtde * 5, -->
<!--               p_exoticas = sum(exoticas) / total_acertos_esperado, -->
<!--               p_nativas = sum(nativas) / total_acertos_esperado, -->
<!--               p_origem_exoticas = sum(origem_exoticas) / total_acertos_esperado, -->
<!--               p_origem_nativas = sum(origem_nativas) / total_acertos_esperado) %>% -->
<!--     ungroup() -->

<!-- # jogo.dados.em.p1 <- jogo.dados.em.p1 %>%  -->
<!-- #     select(area, p_nativas, p_exoticas) -->

<!-- print(jogo.dados.em.p1) -->

<!-- nat_rual <- -->
<!--     jogo.dados.em.p1[jogo.dados.em.p1$area == "Rural", ]$p_nativas -->
<!-- nat_urbana <-  -->
<!--     jogo.dados.em.p1[jogo.dados.em.p1$area == "Urbana", ]$p_nativas -->
<!-- summary(nat_rual) -->
<!-- summary(nat_urbana) -->
<!-- boxplot(nat_rual, nat_urbana) -->

<!-- t.test(nat_rual, nat_urbana,  -->
<!--        alternative = "two.sided", paired = F, var.equal = T) -->


<!-- # shapiro.test(jogo.dados.em.p1$p_nativas) -->
<!-- # shapiro.test(jogo.dados.em.p1$p_exoticas) -->

<!-- area.anova <- aov(jogo.dados.em.p1$p_nativas ~ jogo.dados.em.p1$municipio + jogo.dados.em.p1$area) -->
<!-- summary(area.anova) -->

<!-- # area.anova <- aov(jogo.dados.em.p1$p_exoticas ~ jogo.dados.em.p1$municipio + jogo.dados.em.p1$area) -->
<!-- # summary(area.anova) -->

<!-- ``` -->


<!-- 8. -->

<!-- 9. -->

<!-- 10. Estudantes da Cidade 1 (com UC) tem maior número de acertos de espécies nativas. -->

<!-- ```{r} -->
<!-- jogo.dados.em.p2 <- jogo.dados.em.limpo %>%  -->
<!--     filter(municipio == "Silvânia") %>% -->
<!--     group_by(turmas, flona) %>% -->
<!--     summarise(qtde = n(), -->
<!--               total_acertos_esperado = qtde * 5, -->
<!--               p_exoticas = sum(exoticas) / total_acertos_esperado, -->
<!--               p_nativas = sum(nativas) / total_acertos_esperado, -->
<!--               p_origem_exoticas = sum(origem_exoticas) / total_acertos_esperado, -->
<!--               p_origem_nativas = sum(origem_nativas) / total_acertos_esperado) %>% -->
<!--     ungroup() -->

<!-- print(jogo.dados.em.p2) -->

<!-- nat_uc <- -->
<!--     jogo.dados.em.p2[jogo.dados.em.p2$flona == "Sim", ]$p_nativas -->
<!-- nat_nao_uc <-  -->
<!--     jogo.dados.em.p2[jogo.dados.em.p2$flona == "Não", ]$p_nativas -->
<!-- boxplot(nat_uc, nat_nao_uc) -->

<!-- t.test(nat_uc, nat_nao_uc,  -->
<!--        alternative = "two.sided", paired = F, var.equal = T) -->

<!-- ``` -->
